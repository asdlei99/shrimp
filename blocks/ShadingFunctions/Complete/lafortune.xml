<shrimp name="Lafortune" type="function" description="Lafortune BRDF" author="rconstruct">
    <input name="Ka" description="Ambient light coefficient" type="float" default="0.05"/>
    <input name="Kd" description="Diffuse light coefficient" type="float" default="0.2"/>
    <input name="Ks" description="Specular coefficient" type="float" default="1"/>
    <input name="model" description="Lobe data, range [1,8]" storage="uniform" type="float" default="2"/>
    <input name="colormatrix" description="Color matrix metal/skin, range [1,2]" storage="uniform" type="float" default="2"/>
	<input name="N" description="Surface normal" storage="varying" type="vector normal" default="normalize(N)"/>
	<input name="I" description="Direction of viewer" storage="varying" type="vector" default="normalize(I)"/>
    <input name="direction" description="Surface direction tangent" storage="varying" type="vector" default="dPdu"/>
    <input name="Cs" description="Surface color" type="color" default="color(.3094, .39667, .70837)"/>
	<output name="Ci" description="Shaded color" type="color"/>
	<rsl_include>rsl_shrimp_shadingmodels.h</rsl_include>
	<rsl_code>

	/* Following lobe data taken from Ryan Heniser&apos;s implementation of the
		the Lafortune model (via C shadeop, that is(was) available at 
		The RenderMan Academy (www.rendermanacademy.com). */
		
    /* spray-painted latex blue paint */
    uniform float $(blockname)_coeff_1[27] = {
									 0.877276, 0.801226, 21.88889,
									 0.857255, 0.774290, 18.597755,
									 0.670982, 0.586674, 7.472717,
									-0.419449, 0.008408, 2.594712,
									-0.406681, 0.017625, 2.581499,
									-0.477976, 0.227295, 3.677653,
									-1.031545, 0.706734, 66.899060,
									-1.029426, 0.696530, 63.767912,
									-1.026588, 0.687715, 57.489181
									};
    /* matte finished steel */
    uniform float $(blockname)_coeff_2[27] = {
									-1.11854, 1.01272, 15.8708,
									-1.11845, 1.01469, 15.6489,
									-1.11999, 1.01942, 15.4571,
									-1.05334, 0.69541, 111.267,
									-1.06409, 0.662178, 88.9222,
									-1.08378, 0.626672, 65.2179,
									-1.01684, 1.00132, 180.181,
									-1.01635, 1.00112, 184.152,
									-1.01529, 1.00108, 195.773
									}; 
    /* primer gray */ 
    uniform float $(blockname)_coeff_3[27] = {
									-0.399286, 0.167504, 2.466633,
									-1.033473, 0.009545, 7.637253,
									-1.058104, -0.068002, 8.117645,
									-1.041861, 0.014375, 7.993722,
									-1.100108, -0.198147, 29.446268,
									-1.087779, -0.053605, 41.988990,
									-1.098605, -0.145110, 31.899719,
									-0.379883, 0.159127, 2.372852,
									-0.449038, 0.173224, 2.636161
									};
    /* skin_1 - caucasian male */
    uniform float $(blockname)_coeff_4[27] = {
									-1.131747, -1.209182, 6.421658,
									-1.016939, -1.462488, 3.699932,
									-0.966018, -1.222419, 3.524889,
									-0.546570,  0.380123, 3.685044,
									-0.643533,  0.410559, 4.266495,
									-0.638934,  0.437367, 4.539742,
									-1.020153,  0.703913, 63.919687,
									-1.027479,  0.573625, 43.809866,
									-0.998888,  0.857998, 64.208486
									};
    /* skin_2 - asian male (Only two lobes were used in this approximation,
     * so we make cx=cy=cz=0 for the third lobe) 
     */
    uniform float $(blockname)_coeff_5[27] = {
									-0.418599, 0.399808, 3.327653,
									-0.418849, 0.397372, 3.502029,
									-0.663313, 0.591432, 5.782860,
									-1.030919, 0.832314, 28.298369,
									-1.030556, 0.823648, 25.766759,
									-1.042135, 0.797070, 31.002562,
									 0.000000, 0.000000, 1.00000,
									 0.000000, 0.000000, 1.00000,
									 0.000000, 0.000000, 1.00000
									};
    /* clay */
    uniform float $(blockname)_coeff_6[27] = {
									-1.089701, -1.354682, 17.968505,
									-1.102701, -2.714801, 11.024489,
									-1.107603, -1.569866, 21.270282,
									-0.733381, 0.676108, 8.219745,
									-0.793320, 0.679314, 9.055139,
									-0.848206, 0.726031, 11.261951,
									-1.010548, 0.910783, 152.912795,
									-1.012378, 0.885239, 141.937171,
									-1.011263, 0.892451, 201.046802
									};
	/* skin 3, from Stephen Westin&apos;s test rib for his Lafortune shader */
	uniform float $(blockname)_coeff_7[27] = {
									-0.966019, -1.222419, 3.524889,
									-1.016939, -1.462488, 3.699932,
									-1.131747, -1.209182, 6.421658,
									-0.638934, 0.437367, 4.539742,
									-0.643533, 0.410559, 4.266495,
									-0.546570, 0.380123, 3.685044,
									-1.027479, 0.573625, 43.809866,
									-1.020153, 0.703913, 63.919687,
									-0.998888, 0.8579998, 64.208486
									};
	/* flat blue paint, from Stephen Westin&apos;s Lafortune shader */
	uniform float $(blockname)_coeff_8[27] = {
									-0.870567, 0.803624, 21.820103,
									-0.85725, 0.774290, 18.597755,
									-0.670982, 0.586674, 7.472717,
									 0.451218, 0.023123, 2.774499,
									 0.406681, 0.017624, 2.581499,
									 0.477976, 0.227295, 3.677653,
									 1.031545, 0.706734, 66.899060,
									 1.029426, 0.696530, 63.767912,
									 1.026588, 0.687715, 57.489181
									};

    /* color matrix for: blue paint, matte finished steel */ 
    uniform float $(blockname)_colormatrix_1[9] = { 1, 0, 0, 0, 1, 0, 0, 0, 1 };
	
    /* color matrix for: primer grey, skin_1, skin_2, clay */
    uniform float $(blockname)_colormatrix_2[9] = {
									 1.063302,  0.382044, -0.445346,
									-0.298125,  1.667665, -0.369540,
									-1.322302, -0.446321,  2.768624
									};

        $(Ci) = lafortunersl( $(Ka), $(Kd), $(Ks), $(Cs),
								$(blockname)_coeff_$(model),
								$(blockname)_colormatrix_$(colormatrix),
								$(N), $(I), $(direction),
								DECLARE_AOV_PARAMETERS );

	</rsl_code>
	<usage>Based on Stephen H. Westin&apos;s implementation of the Lafortune model, extended with lobe data from a version by Ryan Heniser. The variable &quot;model&quot; selects the coefficients used, in the range [1,8] being: 1 = spray painted latex blue paint; 2 = matte finished steel; 3 = primer grey; 4 = caucasian male skin; 5 = asian male skin; 6 = clay; 7 = skin; 8 = flat blue paint. The variable &quot;colormatrix&quot; can take the value 1 or 2, being 1 the matrix used for blue paint, matte finished steel; and the value 2 for primer grey, clay, and the skin coefficients. This block passes the resulting values to the &quot;aov_surfacecolor&quot;, &quot;aov_ambient&quot;, &quot;aov_diffuse&quot; and &quot;aov_specular&quot; AOV presets.</usage>
</shrimp>
