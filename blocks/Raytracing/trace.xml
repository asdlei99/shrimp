<shrimp name="Trace" type="function" description="Returns light reaching point P from direction R" author="rconstruct">
    <input name="inpoint" description="Surface point" storage="varying" type="point" default="P"/>
	<input name="indir" description="Direction" storage="varying" type="vector" default="reflect(I, normalize(N))"/>
    <input name="bias" description="Ray bias" storage="uniform" type="float" default="-1"/>
    <input name="maxdist" description="Maximum distance" storage="uniform" type="float" default="1e38"/>
	<input name="samples" description="Ray samples" type="float" default="1"/>
	<input name="coneangle" description="Cone angle" storage="varying" type="float" default="0"/>
	<input name="blur" description="Amount of blur" type="float" default="0.001"/>
	<input name="label" description="Label associated to the ray" storage="uniform" type="string" default="&quot;&quot;"/>
	<input name="subset" description="Set of objects available for ray computations" storage="uniform" type="string" default="&quot;&quot;"/>
	<input name="hitmode" description="Ray hit mode" storage="uniform" type="string" default="&quot;default&quot;"/>
	<input name="hitsides" description="Hit sides" storage="uniform" type="string" default="&quot;front&quot;"/>
	<input name="majoraxis" description="Anisotropy axis" type="vector" default="dPdu"/>
	<input name="majorblur" description="Anisotropy blur" type="float" default="0.01"/>
	<input name="weight" description="Weight for importance sampling" type="float" default="1"/>
	<output name="val" description="Trace value" type="float color"/>
	<output name="dist" description="Optional ray distance" storage="varying" type="float"/>
	<output name="trans" description="Option transmission value" storage="varying" type="color"/>
	<output name="alpha" description="Unoccluded fraction of trace" type="float"/>
	<rsl_code>
	/* make sure options are clear */
	/* and set them according to shadeop and renderer */
	#ifdef RAYOPTIONS
	#undef RAYOPTIONS
	#endif

	/* initialize output */
	$(dist) = 0; $(alpha) = 0; $(trans) = color(0);

	#if RENDERER == pixie
	#define RAYOPTIONS	"bias", $(bias), "samples", \
						$(samples), "samplecone", $(coneangle)			
	#elif RENDERER == _3delight
	#define RAYOPTIONS	$(dist), "label", $(label), "subset", $(subset), \
						"bias", $(bias), "hitmode", $(hitmode), "maxdist", \
						$(maxdist), "samplecone", $(coneangle), "samples", \
						$(samples), "transmission", $(trans)
	#elif RENDERER == prman
	#define RAYOPTIONS	"samplecone", $(coneangle), "bias", $(bias), "label", \
						$(label), "subset", $(subset), "hitmode", $(hitmode), \
						"hitsides", $(hitsides)
	#elif RENDERER == air
	#define RAYOPTIONS	"bias", $(bias), "blur", $(blur), "label", $(label), \
						"maxdist", $(maxdist), "samples", $(samples), \
						"subset", $(subset), "majoraxis", $(majoraxis), \
						"majorblur", $(majorblur), "weight", $(weight), \
						"alpha", $(alpha)
	/* Aqsis has a trace shadeop but returns 0, it can(could?) use */
	/* BMRT's rayserver though. */
	#else
	#define RAYOPTIONS	"bias", $(bias)
	#endif /* RENDERER */
	
	#define $(blockname)_$(val:type)
	#ifdef $(blockname)_float
		$(val) = $(val:type) trace( $(inpoint), $(indir) );
	#else
		$(val) = $(val:type) trace( $(inpoint), $(indir), RAYOPTIONS );
	#endif /* float or color trace */
	#undef $(blockname)_$(val:type)

	</rsl_code>
    <usage>Returns the incident light reaching a point &quot;P&quot; from a given direction &quot;R&quot;. If raytracing isn&apos;t supported, trace will return 0. Bias specifies the bias for the ray starting point, and defaults to -1. Maxdist specifies the distance after which no intersections are checked. If the float version is used, then the distance to the nearest ray intersection is returned instead. Note also that the parameters passed are dependent on the &quot;trace&quot; implementation, so check your renderer&apos;s documentation regarding the specifics of the &quot;trace&quot; function, which will surely vary considerably from renderer to renderer.</usage>
</shrimp>
